<% layout('layouts/boilerplate.ejs')%>

<!-- Header -->
<div class="container col-xxl-8 px-4 py-5">
  <div class="row flex-lg-row-reverse align-items-center g-5 py-5">
    <div class="col-10 col-sm-8 col-lg-6">
      <img
        src="/images/LoginInCap.jpg"
        class="d-block mx-lg-auto img-fluid"
        alt="Bootstrap Themes"
        width="700"
        height="500"
        loading="lazy"
      />
    </div>
    <div class="col-lg-6">
      <h1 class="display-5 fw-bold lh-1 mb-3">please join us.</h1>
      <p class="lead">
        We are book lovers first. This has been built for people like you.
      </p>
      <div class="d-grid gap-2 d-md-flex justify-content-md-start">
        <button type="button" class="btn btn-primary btn-lg px-4 me-md-2">
          Primary
        </button>
        <button type="button" class="btn btn-outline-secondary btn-lg px-4">
          Default
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Feed -->
<div class="container col-xxl-16 px-4 py-5">
  <div class="row flex-lg-row-reverse  g-5 py-5">

    <h1>Updates</h1>

    <% currentUser.friends.forEach(async function(friend) { %> 
      <% feedMessages.forEach(async function(message) { %> 
        <!--  -->
        <% if(message.reader._id.toString() === friend.toString()){ %> 
          <div class="card mb-3 p-3">
            <h5 class="card-title"><%= message.body %></h5>
            <h6 class="card-text mb-2"><%= message.createdAt.toString().slice(0,11)%> </h6>
            <ul class="list-group list-group-flush">
              <%if(message.comments){ %> 
                <% message.comments.forEach(function(comment){%>
                  <li class="list-group-item"><%= comment.body %> - <%= comment.author.username %> </li>
                <%}) %> 
              <% } %> 
            </ul>

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#CommentModal<%= message._id %> ">
              Add comment
            </button>
            <!-- Modal -->
            <div class="modal fade" id="CommentModal<%= message._id %>" tabindex="-1" aria-labelledby="CommentModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="CommentModalLabel">Add A Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form 
                  class="d-flex"
                  action="/feed/<%= message._id %>/comment"
                  method="POST"
                  class="validated-form"
                  novalidate
                  >
                  <div class="modal-body">
                      <input 
                      class="form-control me-2"
                      placeholder="Comment"
                      type="text"
                      id="comment"
                      name="comment"
                      aria-label="feed[Comment]"
                      required
                      autofocus
                      >
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Comment</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <% } %> 
        <!--  -->
        <% } )%>
      <% } )%>
  </div>
</div>

<!-- REcent Reviews -->
<div class="container col-xxl-16 px-4 py-5">
  <div class="row flex-lg-row-reverse  g-5 py-5">
    <div class="col-10 col-sm-8 col-lg-6">
      <h2 class="display-5 fw-bold lh-1 mb-3">Recent reviews</h2>

      <% books.forEach(async function(book) { %> 
        <!--  -->
      <%if(book.reviews.length > 0){ %>
        <!--  -->
      <% book.reviews.forEach(async function(review) { %>
      <div class="card mb-3 p-3">
        <!-- if book has review -->
        <h5 class="card-title fw-bold"><%= book.title %></h5>
        <h5 class="card-title"><%= review.writer.username %></h5>
        <h6 class="card-text mb-2"><%= review.body%></h6>
        <p class="starability-result" data-rating="<%= review.rating %>">
          Rated <%= review.rating %> stars
        </p>

        <!-- End for all books -->
        <a href="/books/<%= book._id %> " class="btn btn-primary btn-sm"
          >View <%= book.title %>
          </a>
          </div>
          <% } )%>
          <!--  -->
      <% } %> 
      <!--  -->
      <% } )%>
    </div>

    <!-- Recent users -->
    <div class="col-lg-6">
      <!-- for all books -->
      <h2 class="display-5 fw-bold lh-1 mb-3">Recent users</h2>
      <% users.forEach(async function(user) { %>

      <div class="card mb-3 p-3">
        <a href="/user/<%= user._id %> "
          ><h5 class="card-title "><%= user.username %></h5></a
        >
        <h5 class="card-subtitle"><%= user.email %></h5>
      </div>

      <% } )%>
    </div>
  </div>
</div>
</div>
</div>

